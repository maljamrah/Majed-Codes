--First three KPIs------------Demographics (Most-Recent Answers)-------------
-- All HRSN members YTD with Seeker ID, Race, Ethnicity, and Language
-- Picks the most recent answer per member
-- ================================================================================

DECLARE @start_date date = '2025-01-01';
DECLARE @end_date   date = CAST(GETDATE() AS date);

WITH responses_ytd AS (
    SELECT
        seeker_id,
        question,
        answer,
        form_name,
        started_at,
        form_submission_id  -- useful for tie-breaking if same timestamp
    FROM FH_flipa_mbr_insights_forms
    WHERE seeker_id IS NOT NULL
      AND form_name LIKE '%HRSN%'            -- HRSN filter
      AND started_at >= @start_date
      AND started_at < DATEADD(day, 1, @end_date)
),
seekers AS (
    SELECT DISTINCT seeker_id
    FROM responses_ytd
)
SELECT
    s.seeker_id,
    rc.race,
    ec.ethnicity,
    lc.language,
    @end_date AS data_through_date
FROM seekers s

-- Most recent Race
OUTER APPLY (
    SELECT TOP (1) r.answer AS race
    FROM responses_ytd r
    WHERE r.seeker_id = s.seeker_id
      AND LOWER(r.question) LIKE '%race%'
      AND r.answer IS NOT NULL AND LTRIM(RTRIM(r.answer)) <> ''
    ORDER BY r.started_at DESC, r.form_submission_id DESC
) rc

-- Most recent Ethnicity
OUTER APPLY (
    SELECT TOP (1) r.answer AS ethnicity
    FROM responses_ytd r
    WHERE r.seeker_id = s.seeker_id
      AND LOWER(r.question) LIKE '%ethnic%'
      AND r.answer IS NOT NULL AND LTRIM(RTRIM(r.answer)) <> ''
    ORDER BY r.started_at DESC, r.form_submission_id DESC
) ec

-- Most recent Language
OUTER APPLY (
    SELECT TOP (1) r.answer AS language
    FROM responses_ytd r
    WHERE r.seeker_id = s.seeker_id
      AND LOWER(r.question) LIKE '%language%'
      AND r.answer IS NOT NULL AND LTRIM(RTRIM(r.answer)) <> ''
    ORDER BY r.started_at DESC, r.form_submission_id DESC
) lc

ORDER BY s.seeker_id;







